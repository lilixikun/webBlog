# æµè§ˆå™¨æ¸²æŸ“æµç¨‹

**åˆ†æï¼š**

 	1. ç½‘é¡µçš„æ¸²æŸ“æµç¨‹
      	1. æµè§ˆå™¨çš„domæ˜¯åˆ†å±‚çš„ï¼Œç½‘é¡µæ˜¯3Dçš„ã€‚
      	2. å¯¹DOMå…ƒç´ èŠ‚ç‚¹è®¡ç®—æ ·å¼ç»“æœ Recalculate Styleæ ·å¼é‡è®¡ç®—
      	3. ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆå›¾å½¢ä½ç½®Layoutå›æµé‡æ’
      	4. å°†æ¯ä¸ªèŠ‚ç‚¹ç»˜åˆ¶å¡«å……åˆ°å›¾å±‚ä¸­Paint
      	5. å›¾å±‚ä½œä¸ºçº¹ç†ä¸Šä¼ åˆ°GPU
      	6. Composite Layers åˆæˆå±‚æŠŠç¬¦åˆå›¾å±‚ç”Ÿæˆåˆ°é¡µé¢
    2. Composite Layers åšäº†ä»€ä¹ˆï¼Ÿ
           	1. å›¾å±‚çš„ç»˜åˆ¶åˆ—è¡¨ï¼Œå‡†å¤‡å¥½ï¼Œä¸»çº¿ç¨‹ commit åˆæˆçº¿ç¨‹
           	2. åˆæˆçº¿ç¨‹ viewport rt åˆ’åˆ†å›¾å—
           	3. ç”Ÿæˆä½å›¾   æ …æ ¼åŒ–ï¼ˆå…‰æ …åŒ–ï¼‰ raster
           	4. æ‰€æœ‰å›¾å— GPUåˆæˆç”ŸæˆDarwQuadæäº¤ç»™æµè§ˆå™¨æ¸²æŸ“è¿›ç¨‹
           	5. vizç»„ä»¶  æ¥æ”¶åˆ°DarwQuad ç»˜åˆ¶åˆ°æˆ‘ä»¬çš„å±å¹•ä¸Š

## é¡µé¢åˆ†å±‚

::: tip çŸ¥é“å—?ğŸ¤”
é‚£äº›å±æ€§ä¼šåˆ†å±‚?å¦‚ä½•æŸ¥çœ‹å›¾å±‚?
:::

åœ¨ **performance** é‡Œé¢ç‚¹å‡» **Layers** å¯ä»¥çœ‹åˆ°å›¾å±‚çš„åˆ—è¡¨

- æ ¹å…ƒç´ 

- position

- transform

- åŠé€æ˜

- cssæ»¤é•œ

- canvas

- video

- overflow

é¡µé¢å…‰åˆ†å±‚ä¸è¡Œ,è®© **GPU** å‚ä¸å·¥ä½œæ‰æ˜¯æå‡æ€§èƒ½çš„ç‹é“,é‚£äº›å±æ€§èƒ½è®© **GPU** å‚ä¸å·¥ä½œå‘¢?

## GPU ç¡¬ä»¶åŠ é€Ÿ

- CSS3D

- video

- webgl

- transform

- will-change:transform

## å½±å“é‡ç»˜å’Œé‡æ’çš„æ“ä½œ

**é‡ç»˜** æ˜¯æˆ‘ä»¬æ”¹åŠ¨å…ƒç´ çš„å­—ä½“é¢œè‰²,èƒŒæ™¯è‰²ç­‰å¤–è§‚å…ƒç´ æ—¶å€™,å¹¶ä¸ä¼šæ”¹å˜å®ƒçš„å¤§å°,ä¹Ÿä¸ä¼šå½±å“å…¶ä»–å…ƒç´ çš„å¸ƒå±€,è¿™ä¸ªæ—¶å€™å°±ä¸éœ€è¦é‡æ–°æ„å»ºæ¸²æŸ“æ ‘ã€‚æµè§ˆå™¨ä¼šå¯¹å…ƒç´ çš„æ ·å¼é‡æ–°ç»˜åˆ¶,è¿™ä¸ªè¿‡ç¨‹å«åš "é‡ç»˜"

é‡ç»˜çš„è§¦å‘: ä»»ä½•å¯¹å…ƒç´ æ ·å¼,å¦‚ **color**,**background-color** ç­‰å±æ€§çš„æ”¹å˜,JSå’ŒCSSéƒ½ä¼šå¼•èµ·é‡ç»˜ã€‚

**é‡æ’** ä¸€èˆ¬æ¥è¯´ç›’å­åŠ¨äº†å¿…å®šå¿…å®šä¼š **é‡æ’**,å› æ­¤å»ºè®®ä½¿ç”¨æ€ªå¼‚ç›’æ¨¡å‹,å›ºå®šç›’å­çš„å¤§å°.

> é‡æ’å¿…å®šå¼•èµ·é‡ç»˜

- æ·»åŠ /åˆ é™¤å…ƒç´ 
- å†…å®¹å‘ç”Ÿæ”¹å˜(æ–‡å­—æ•°é‡æˆ–å›¾ç‰‡å¤§å°ç­‰ç­‰)
- display:none
- ç§»åŠ¨å…ƒç´ ä½ç½®
- ä¿®æ”¹æµè§ˆå™¨å¤§å°,å­—ä½“å¤§å°

**è¿˜æœ‰ä¸€äº›è¯»å–æ“ä½œä¹Ÿå¯èƒ½å¼•èµ·é‡æ’**

- offset(Top|Left|Width|Height)
- scroll(Top|Left|Width|Height)
- client(Top|Left|Width|Height)
- getComputedStyle()

::: warning è¿™é‡Œæœ‰ä¸ªç–‘é—®ğŸ¤”ï¸
ä¸ºä»€ä¹ˆè¯»å–ä¹Ÿä¼šé€ æˆ**é‡æ’**?
:::

å› ä¸ºåœ¨ç”¨JSæ“ä½œDOMæ—¶,æµè§ˆå™¨ä¼šæŠŠæ“ä½œç»´æŠ¤åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­,å½“è¾¾åˆ°ä¸€å®šçš„æ•°é‡æµè§ˆå™¨å†ç»Ÿä¸€å»æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ“ä½œ.å½“å»æŸ¥è¯¢è¿™äº›å±æ€§æ—¶,æµè§ˆå™¨å°±ä¼šå¼ºåˆ¶åˆ·æ–°é˜Ÿåˆ—ã€‚å› ä¸ºå¦‚æœä¸ç«‹å³æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡,æœ‰å¯èƒ½å¾—åˆ°çš„ç»“æœæ˜¯é”™è¯¯çš„ã€‚ç›¸å½“äºä½ å¼ºåˆ¶æ‰“æ–­äº†æµè§ˆå™¨çš„ä¼˜åŒ–æµç¨‹ï¼Œå¼•èµ·äº†é‡æ’.

::: tip ä¸çŸ¥é“å“ªäº›å±æ€§å½±å“å’‹åŠğŸ¤”ï¸
**[csstriggers](https://csstriggers.com/)  å¯æŸ¥çœ‹æ˜¯å¦å¼•èµ·é‡æ’é‡ç»˜**
:::

## å‡å°‘é‡ç»˜

åˆ©ç”¨ **DevTools** è¯†åˆ« paint çš„ç“¶é¢ˆ,Chrome å·¥å…·çš„ä½¿ç”¨

![chrome](/optimization/chrome_performance_test.png)

	è“è‰²:ç½‘ç»œé€šä¿¡å’Œ HTML è§£æ
	é»„è‰²:JavaScript æ‰§è¡Œæ—¶é—´
	ç´«è‰²:æ ·å¼è®¡ç®—å’Œå¸ƒå±€,å³ Layout é‡æ’
	ç»¿è‰²:Paint é‡ç»˜

**CSS æ˜¯å¦ä¼šå¼•èµ·é‡æ’å’Œé‡ç»˜**?

åœ¨ [ä¾‹å­](https://github.com/LiLixikun/Blog-example/blob/master/packages/performance/box1.html) ä¸­æˆ‘ä»¬æ‰“å¼€ **performance** è¿›è¡Œå½•åˆ¶

![reflow](/optimization/reflow.png)

å‘ç°ä¸€ç›´åœ¨æ‰§è¡Œ Layout(é‡æ’)-Paint(é‡ç»˜)-Composite Layers(åˆæˆ)çš„è¿‡ç¨‹

ä½¿ç”¨ **transform** å¼€å¯ç¡¬ä»¶åŠ é€Ÿå,å†æ¬¡å½•åˆ¶å¦‚ä¸‹:

![box-transform](/optimization/box-transform.png)

å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ä¸»çº¿ç¨‹ç°åœ¨å¤„äºç©ºé—²çŠ¶æ€,è€Œ **GPU** å‚ä¸äº†å·¥ä½œ,ç›´æ¥è·³è¿‡äº†é‡ç»˜å’Œé‡æ’çš„è¿‡ç¨‹,å¤§å¤§çš„æå‡äº†æ€§èƒ½!

::: tip å°ç»“
ä½¿ç”¨ **top** **left** ä¼šå‘ç°ä¸æ–­çš„é‡æ’å’Œé‡ç»˜

ä½¿ç”¨ **transform** åˆ™æ²¡æœ‰ 
:::

## ä½¿ç”¨ fastdom

åœ¨ [fastdomäº‹ä¾‹](http://wilsonpage.github.io/fastdom/examples/animation.html) ä¸­æˆ‘ä»¬å¯ä»¥æ˜ç¡®çš„æ„Ÿè§‰åˆ°ç”¨äº† **fastdom** é¡µé¢æµç•…è®¸å¤š

ç°åœ¨æˆ‘ä»¬è‡ªå·±æ¥å†™ä¸ªç®€å• [demo](https://github.com/LiLixikun/Blog-example/blob/master/packages/performance/fastdom.html) æ“ä½œä¸‹:

æˆ‘ä»¬ç‚¹å¼€ **performance**,æŸ¥çœ‹é¡µé¢ç»˜åˆ¶è¿‡ç¨‹å‘ç°ä¸åœçš„ **Recalculate** å’Œè¿›è¡Œ **layout** 

![layout](/optimization/fastdom.png)

ä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨ [fastdom](https://github.com/LiLixikun/Blog-example/blob/master/packages/performance/fastdom1.html) è¿›è¡Œè¯»å†™åˆ†ç¦»å,å‘ç°è¿›è¡Œäº†ç»Ÿä¸€çš„æ“ä½œ,å¤§å¤§å‡å°‘äº†æµè§ˆå™¨çš„å¼€é”€

![layout](/optimization/fastdom1.png)

## requestAnimationFrame

å¦‚æœæƒ³æ‰§è¡ŒåŠ¨ç”»æ“ä½œ,å¯ä»¥ä½¿ç”¨ **requestAnimationFrame** è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»,å¯ä»¥è¾¾åˆ°å’Œæµè§ˆå™¨åŒæ­¥åˆ·æ–°,ä»¥é¿å…ä¸å¿…è¦çš„å¼€é”€.

## æ€»ç»“

![zongjie.png](/optimization/zongjie.png)
