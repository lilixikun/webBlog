# æºç è§£æä¸‰

ä¸Šç« è¯´åˆ°,webpack-cli æ£€æµ‹åˆå¹¶å®Œå°±ä¼šå»æ‰§è¡Œ **webpack(options)**,å»åˆ° webpack/lib/webpack.js,æˆ‘ä»¬æ‰“å°ä¸‹ **options** æ¥çœ‹çœ‹
![webpack-init](/webpack/webpack-init.png)

æˆ‘ä»¬æ¥çœ‹çœ‹ webpack è¿™ä¸ªå‡½æ•°å…·ä½“åšäº†ä»€ä¹ˆ

## webpack

```js
const webpack = (options, callback) => {
	const webpackOptionsValidationErrors = validateSchema(
		webpackOptionsSchema,
		options
	);
	if (webpackOptionsValidationErrors.length) {
		throw new WebpackOptionsValidationError(webpackOptionsValidationErrors);
	}
	let compiler;
	if (Array.isArray(options)) {
		compiler = new MultiCompiler(
			Array.from(options).map(options => webpack(options))
		);
	} else if (typeof options === "object") {
		options = new WebpackOptionsDefaulter().process(options);

		compiler = new Compiler(options.context);
		compiler.options = options;
		new NodeEnvironmentPlugin({
			infrastructureLogging: options.infrastructureLogging
		}).apply(compiler);
		if (options.plugins && Array.isArray(options.plugins)) {
			for (const plugin of options.plugins) {
				if (typeof plugin === "function") {
					plugin.call(compiler, compiler);
				} else {
					plugin.apply(compiler);
				}
			}
		}
		compiler.hooks.environment.call();
		compiler.hooks.afterEnvironment.call();
		compiler.options = new WebpackOptionsApply().process(options, compiler);
	} else {
		throw new Error("Invalid argument: options");
	}
	if (callback) {
		if (typeof callback !== "function") {
			throw new Error("Invalid argument: callback");
		}
		if (
			options.watch === true ||
			(Array.isArray(options) && options.some(o => o.watch))
		) {
			const watchOptions = Array.isArray(options)
				? options.map(o => o.watchOptions || {})
				: options.watchOptions || {};
			return compiler.watch(watchOptions, callback);
		}
		compiler.run(callback);
	}
	return compiler;
};
```

ä¸Šé¢æ‰“å° options æ˜¯ä¸ªå¯¹è±¡,å› æ­¤ä¼šèµ°ç¬¬äºŒä¸ªåˆ†æ”¯, å» **require("./WebpackOptionsDefaulter")** çœ‹çœ‹

## WebpackOptionsDefaulter

```js
class WebpackOptionsDefaulter extends OptionsDefaulter {
    	super();

		this.set("entry", "./src");

		this.set("devtool", "make", options =>
			options.mode === "development" ? "eval" : false
		);
		this.set("cache", "make", options => options.mode === "development");

		this.set("context", process.cwd());
        this.set("target", "web");
        ...
    }
}
```
çœ‹ä¸€ä¸‹å°±å·®ä¸å¤šæ‡‚äº†,å°±æ˜¯é»˜è®¤è®¾ç½®ä¸€äº›å‚æ•°é…ç½®,æ’ä»¶,loader ç­‰ç­‰,æåˆ°è¿™ å°±å¾ˆè›‹ç–¼äº†,æ•´äº†å¤§åŠåœˆå°¼ç›è¿˜åœ¨ webpack é…ç½®è¿™é‡Œè½¬åœˆ,æˆ‘ ğŸ˜“

## new Compiler
ä¸Šé¢æ•´å®Œ options å,æ‰§è¡Œäº† **new Compiler**, å¹¶ä¼ å…¥äº† options.context,è€è§„çŸ©,è¿›å» **Compiler** è¿›å»çœ‹çœ‹å‘—

```js
const {Tapable,SyncHook,SyncBailHook,AsyncParallelHook,AsyncSeriesHook} = require("tapable");
class Compiler extends Tapable {
	constructor(context) {
		super();
		this.hooks = {
            // ...
			/** @type {AsyncSeriesHook<Compiler>} */
			beforeRun: new AsyncSeriesHook(["compiler"]),
			/** @type {AsyncSeriesHook<Compiler>} */
			run: new AsyncSeriesHook(["compiler"]),
			/** @type {AsyncSeriesHook<Compilation>} */
            emit: new AsyncSeriesHook(["compilation"]),
            // ...
        }
        /** @type {boolean} */
		this.running = false;

		/** @type {boolean} */
		this.watchMode = false;
    }
    watch()
    run()

    emitAssets()
}          
```
å¯ä»¥çœ‹åˆ° Compiler ç»§æ‰¿ **Tapable**,ç„¶åå®šä¹‰äº†ä¸€å † **hooks** å’Œæ–¹æ³•

## tapable
è¿™é‡Œç®€å•è¯´ä¸‹ tapable,**SyncHook** æ˜¯å¤„ç†ä¸²è¡ŒåŒæ­¥æ‰§è¡Œçš„æ–‡ä»¶,åœ¨è§¦å‘äº‹ä»¶ä¹‹åï¼Œä¼šæŒ‰ç…§äº‹ä»¶æ³¨å†Œçš„å…ˆåé¡ºåºæ‰§è¡Œæ‰€æœ‰çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚å¦‚ä¸‹:
```js
// åˆ›å»ºå®åˆ—
const syncHook = new SyncHook(["name", "age"]);

// æ³¨å†Œäº‹ä»¶
syncHook.tap("1", (name, age) => {
  console.log("1", name, age);
});
syncHook.tap("2", (name, age) => {
  console.log("2", name, age);
});
syncHook.tap("3", (name, age) => {
  console.log("3", name, age);
});

// è§¦å‘äº‹ä»¶ï¼Œè®©ç›‘å¬å‡½æ•°æ‰§è¡Œ
syncHook.call("kongzhiEvent-1", 18);
```
å¯ä»¥çœ‹åˆ°æ‰§è¡Œäº† call æ‰€æœ‰çš„æ‰§è¡Œäº†å„è‡ªçš„æ‰“å° 1/2/3,å¹¶ä¸”è¾“å‡ºäº† name:kongzhiEvent-1,age:18

## plugin
å›åˆ°å¯¹åº”ä¸Šé¢,åˆ¤æ–­é…ç½®optionsé‡Œé¢çš„plugins,å¹¶ä¸”ä¾æ¬¡æ‰§è¡Œ
```js
if (options.plugins && Array.isArray(options.plugins)) {
    for (const plugin of options.plugins) {
        if (typeof plugin === "function") {
            plugin.call(compiler, compiler);
        } else {
            plugin.apply(compiler);
        }
    }
}
compiler.hooks.environment.call();
compiler.hooks.afterEnvironment.call();
```
ä¸Šé¢å¯ä»¥çœ‹åˆ°,å¦‚æœ plugin æ˜¯ä¸€ä¸ªå‡½æ•°,æ‰§è¡Œ callå¹¶ä¼ å…¥ **compiler**,å¦åˆ™é€šè¿‡ plugin.apply æ¥æ‰§è¡Œ,æˆ‘ä»¬ä¹‹å‰æœ‰ç¼–å†™ plugin çš„ç»éªŒ å¦‚ä¸‹:
```js
class HtmlAfterPlugin {
    apply(compiler) {
        compiler.hooks.compilation.tap(pluginName, (compilation) => {

        })
    }
}
```
ä¹‹å‰ä¸æ˜¯å¾ˆæ‡‚ä¸ºä»€ä¹ˆè¦ç¼–å†™è¿™ä¹ˆä¸€é™€ä¸œè¥¿ **compiler.hooks.compilation.tap**,ç°åœ¨æœ‰ç§æç„¶å¤§æ‚Ÿ,æˆ‘çš„plugin åªè¦æ‰§è¡Œ **tap**ç›‘å¬,ä½ é‚£è¾¹ä¸€ **call** æˆ‘æ‰€æœ‰ä¸éƒ½å¯ä»¥æ”¶åˆ°äº†å˜›ğŸ˜Š

## Cli
ä¸Šé¢è¿”å› compiler å,è®©æˆ‘ä»¬å†æ¬¡å›åˆ° clié‡Œé¢,è¿™é‡Œæœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­

```js
function compilerCallback(err, stats){

}
if (firstOptions.watch || options.watch) {
    // ...
    compiler.watch(watchOptions, compilerCallback);
} else {
    compiler.run((err, stats) => {
        if (compiler.close) {
            compiler.close(err2 => {
                compilerCallback(err || err2, stats);
            });
        } else {
            compilerCallback(err, stats);
        }
    });
}
```

è¿™é‡Œå°±æ˜¯è¿›è¡Œä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æœ‰ **watch**,æœ‰åˆ™èµ° compiler.watch,æ— åˆ™èµ° compiler.run,è¿™é‡Œæˆ‘ä»¬èµ°compiler.run,è¿›å…¥ webpack æ ¸å¿ƒæ„å»ºæµç¨‹ï¼

## å°ç»“
1. é€šè¿‡å®ä¾‹ WebpackOptionsDefaulter ä¼šç»™ webpack è®¾ç½®é»˜è®¤é…ç½®
2. å®ä¾‹è¯ Compiler,å®ƒç»§æ‰¿ Tapable,æ˜¯ webpack çš„æ ¸å¿ƒ
3. éå†æ‰§è¡Œ plugins,æ¯ä¸ª plugin æ‰§è¡Œ call æˆ–è€… apply ä¸€ä¸‹,ä¼ å…¥ compiler
4. compiler æ‰§è¡Œ call
5. æœ€åæ ¹æ®é…ç½®æ˜¯å¦æœ‰ watch æ¥å†³å®šç¨‹åºèµ°å‘ã€‚
