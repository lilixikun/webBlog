# æºç åˆ†ææ€»ç»“

## JS Module Bundler

**webpack** æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª **JS Module Bundler**,ç”¨äºå°†å¤šä¸ªä»£ç æ¨¡å—è¿›è¡Œæ‰“åŒ…ã€‚ **bundler** ä»ä¸€ä¸ªæ„å»ºå…¥å£è§¦å‘,è§£æä»£ç ,åˆ†æå‡ºä»£ç æ¨¡å—çš„ä¾èµ–å…³ç³»,ç„¶åå°†ä¾èµ–çš„ä»£ç  æ¨¡å—ç»„åˆåœ¨ä¸€èµ·,åœ¨ bundler ä¸­,æä¾›äº†ä¸€äº›èƒ¶æ°´ä»£ç è®©å¤šä¸ªä»£ç æ¨¡å—å¯ä»¥ååŒå·¥ä½œ,äº’ç›¸å¼•ç”¨ã€‚å¦‚ä¸‹ä¸¾ä¸€äº›ç®€å•çš„ä¾‹å­:

```js
// entry.js
import {bar} from './bar.js' //ä¾èµ– ./bar.js æ¨¡å—
// bar.js
const foo = require('./foo.js') //ä¾èµ– ./foo.js æ¨¡å—
```
é€’å½’ä¸‹å»,ç›´è‡³æ²¡æœ‰æ›´å¤šçš„ä¾èµ–æ¨¡å—,æœ€ç»ˆå½¢æˆä¸€ä¸ªæ¨¡å—ä¾èµ–æ ‘

åˆ†æå‡ºä¾èµ–å…³ç³»å,webpack ä¼šåˆ©ç”¨ **JavaScript Function** çš„ç‰¹æ€§æä¾›ä¸€äº›ä»£ç æ¥å°†å„ä¸ªæ¨¡å—æ•´åˆåˆ°ä¸€èµ·,å³æ˜¯å°†æ¯ä¸€ä¸ªæ¨¡å—åŒ…è£…æˆä¸€ä¸ª **JS Function**,æä¾›ä¸€ä¸ªå¼•ç”¨ä¾èµ–æ¨¡å—çš„æ–¹æ³•,æ¯”å¦‚ **_webpack_require_**,è¿™æ ·åš,å³å¯ä»¥é¿å…å˜é‡äº’ç›¸å¹²æ‰°,åˆèƒ½å¤Ÿæœ‰æ•ˆæ§åˆ¶æ‰§è¡Œé¡ºåº

```js
// åˆ†åˆ«å°†å„ä¸ªæ¨¡å—ä¾èµ–çš„ä»£ç ç”¨ modules çš„æ–¹æ³•æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶
// entry.js
modules['./entry.js'] = function(){
    const {bar} = _webpack_require_('./bar.js')
}
// bar
modules['./bar.js'] = function(){
    const {bar} = _webpack_require_('./foo.js')
}

modules['./entry.js'] = function(){
    // ...
}
```

å·²ç»æ‰§è¡Œçš„ä»£ç  æ¨¡å—ç»“æœä¼šä¿å­˜åœ¨ installedModules é‡Œé¢
```js
const installedModules = {}
function __webpack_require__(moduleId) {
        console.log(moduleId);
        // æ£€æŸ¥ module æ˜¯å¦åœ¨ç¼“å­˜ä¸­
        if (installedModules[moduleId]) {
            return installedModules[moduleId].exports;
        }
        // åˆ›å»ºä¸€ä¸ª module
        var module = installedModules[moduleId] = {
            i: moduleId,
            l: false,
            exports: {}
        };

        // æ‰§è¡Œ module é‡Œé¢çš„æ–¹æ³•
        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

        // è®¾ç½®åŠ è½½çŠ¶æ€
        module.l = true;

        // è¿”å› module
        return module.exports;
    }
```
å…·ä½“å¯ä»¥æŸ¥çœ‹ [æºç åˆ†æä¸€](/blog/webpack/æºç è§£æä¸€) 

## æ„å»ºè¿‡ç¨‹

![running-process](/webpack/running-process.png)
1. **Compiler** webpack çš„è¿è¡Œå…¥å£, compiler å¯¹è±¡ä»£è¡¨äº†å®Œæ•´çš„ webpack ç¯å¢ƒé…ç½®. è¿™ä¸ªå¯¹è±¡åœ¨å¯åŠ¨ webpack æ—¶è¢«ä¸€æ¬¡æ€§ç®€å†,å¹¶é…ç½®å¥½æ‰€æœ‰å¯æ“ä½œçš„è®¾ç½®,åŒ…æ‹¬ **options**,**loader** å’Œ **plugin**. å½“åœ¨ webpack ç¯å¢ƒä¸­åº”ç”¨ä¸€ä¸ªæ’ä»¶æ—¶,æ’ä»¶å°†æ”¶åˆ° æ­¤ compiler å¯¹è±¡çš„å¼•ç”¨,å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—® webpack çš„ä¸»ç¯å¢ƒ

2. **Compilation** å¯¹è±¡ä»£è¡¨äº†ä¸€æ¬¡èµ„æºç‰ˆæœ¬çš„æ„å»º. å½“è¿è¡Œ webpack å¼€å‘ç¯å¢ƒä¸­é—´ä»¶æ—¶,æ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–,å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ compilation,ä»è€Œç”Ÿæˆä¸€ç»„æ–°çš„ç¼–è¯‘èµ„æº. ä¸€ä¸ª compilation å¯¹è±¡è¡¨ç°äº†å½“å‰çš„ æ¨¡å—èµ„æº,ç¼–è¯‘ç”Ÿæˆèµ„æº,å˜åŒ–çš„æ–‡ä»¶,ä»¥åŠè¢«è·Ÿè¸ªä¾èµ–çš„çŠ¶æ€ä¿¡æ¯ã€‚compilation å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šå…³é”®æ­¥éª¤çš„å›è°ƒ,ä»¥ä¾›æ’ä»¶åšè‡ªå®šä¹‰å¤„ç†æ—¶é€‰æ‹©ä½¿ç”¨

3. **Chunk**,å³ç”¨äºè¡¨ç¤º chunk çš„ç±»,å¯¹äºæ„å»ºæ—¶éœ€è¦çš„ chunk å¯¹è±¡ç”± **Compilation** åˆ›å»ºåä¿å­˜ç®¡ç†

4. [Module](https://github.com/webpack/webpack/blob/master/lib/Module.js),ç”¨æ¥è¡¨ç¤ºä»£ç æ¨¡å—çš„åŸºç¡€ç±»,è¡ç”Ÿå‡ºå¾ˆå¤šå­ç±»ç”¨äºå¤„ç†ä¸åŒçš„æƒ…å†µ [NormalModule](https://github.com/webpack/webpack/blob/master/lib/NormalModule.js),å…³äºä»£ç æ¨¡å—çš„æ‰€æœ‰ä¿¡æ¯éƒ½ä¼šå­˜åœ¨ **Module** å®ä¾‹ä¸­,å¦‚ **dependencies** è®°å½•ä»£ç æ¨¡å—çš„ä¾èµ–ç­‰ã€‚å½“ä¸€ä¸ª Module å®ä¾‹è¢«åˆ›å»ºå,æ¯”è¾ƒé‡è¦çš„ä¸€æ­¥å››æ‰§è¡Œ **compilation.buildModule** è¿™ä¸ªæ–¹æ³•,å®ƒä¼šè°ƒç”¨ Module å®ä¾‹çš„build æ–¹æ³•æ¥åˆ›å»º Module å®ä¾‹éœ€è¦çš„ä¸€äº›ä¸œè¥¿,ç„¶åè°ƒç”¨è‡ªèº«çš„ **runLoaders** æ–¹æ³•,æ‰§è¡Œå¯¹äºçš„ **loaders**,å°†ä»£ç æºç å†…å®¹ä¸€ä¸€ äº¤ ç”±é…ç½®ä¸­æŒ‡å®šçš„ loader å¤„ç†å,å†æŠŠå¤„ç†çš„ç»“æœ ä¿å­˜èµ·æ¥

5. **Parser**:åŸºäº [acorn](https://github.com/acornjs/acorn) æ¥åˆ†æ **AST** è¯­æ³•æ ‘,è§£æå‡ºä»£ç æ¨¡å—çš„ä¾èµ–

6. **Dependency**:è§£ææ˜¯ç”¨äºä¿å­˜ä»£ç æ¨¡å—å¯¹åº”çš„ä¾èµ–ä½¿ç”¨çš„å¯¹è±¡ã€‚Module å®ä¾‹ build æ–¹æ³•åœ¨æ‰§è¡Œå®Œå¯¹åº”çš„loaderæ—¶,å¤„ç†å®Œæ¨¡å—å¸¦å•Šè‡ªèº«çš„è½¬æ¢å,ç»§ç»­è°ƒç”¨ **Parser** çš„å®ä¾‹æ¥è§£æè‡ªèº«ä¾èµ–çš„æ¨¡å—,è§£æåçš„ç»“æœå­˜æ”¾åœ¨  **module.dependenuies** ä¸­,é¦–å…ˆä¿å­˜çš„æ˜¯ä¾èµ–çš„è·¯å¾„,åç»­ä¼šç»è¿‡ compilation.processModuleDepencies æ–¹æ³•,å†æ¥å¤„ç†å„ä¸ªä¾èµ–æ¨¡å—,é€’å½’åœ°å»å»ºç«‹ æ•´ä¸ªä¾èµ–

7. [Template](https://github.com/webpack/webpack/blob/master/lib/Template.js),ç”Ÿæˆæœ€ç»ˆä»£ç è¦ä½¿ç”¨åˆ°çš„ä»£ç æ¨¡ç‰ˆ,æ‰“åŒ…å®Œçš„ä»£ç å°±æ˜¯ç”¨å¯¹åº”çš„ Template æ¥ç”Ÿæˆ

## ç¼–è¯‘é¡ºåº

webpackçš„ç¼–è¯‘éƒ½æŒ‰ç…§ä¸‹é¢çš„é’©å­è°ƒç”¨é¡ºåºæ‰§è¡Œ

![order](/webpack/order.png)

## ç¼–å†™è‡ªå·±çš„æ’ä»¶
**webpack** å®ç°æ’ä»¶æœºåˆ¶çš„å¤§ä½“æ–¹å¼å¦‚ä¸‹:
- **åˆ›å»º** -- webpack åœ¨å…¶å†…éƒ¨å¯¹è±¡ä¸Šåˆ›å»ºå„ç§é’©å­
- **æ³¨å†Œ** -- æ’ä»¶å°†è‡ªå·±çš„æ–¹æ³•æ³¨å†Œåˆ°å¯¹åº”çš„é’©å­ä¸Š,äº¤ç»™ webpack
- **è°ƒç”¨** -- webpack ç¼–è¯‘è¿‡ç¨‹ä¸­,ä¼šé€‚æ—¶çš„è§¦å‘ç›¸åº”çš„é’©å­,å› æ­¤ä¹Ÿå°±è§¦å‘äº†æ’ä»¶çš„æ–¹æ³•

å¦‚ä¸‹ä¸€ä¸ªç®€å•ä¾‹å­ğŸŒ°

```js
const pluginName = 'ConsoleLogBuildPlugin'

class ConsoleLogBuildPlugin {

    apply(compiler) {
        // åœ¨ compiler çš„hooksä¸­æ³¨å†Œä¸€ä¸ªæ–¹æ³•,å½“æ‰§è¡Œåˆ°è¯¥é˜¶æ®µä¼šè°ƒç”¨
        compiler.hooks.run.tap(pluginName, (compilation) => {

            console.log('The webpack build process is starting');
        })
    }
}
module.exports = ConsoleLogBuildPlugin
```

1. äº‹ä»¶é’©å­ä¼šæœ‰ä¸åŒçš„ç±»å‹ **SyncBailHook**,**AsyncSeriesHook**,**SyncHook** ç­‰
2. å¦‚æœæ˜¯å¼‚æ­¥äº‹ä»¶é’©å­,é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ **tapPromise** æˆ–è€… **tapAsync** æ¥æ³¨å†Œäº‹ä»¶å‡½æ•°,**tapPromise** è¦æ±‚æ–¹æ³•è¿”å› Promise ä»¥ä¾¿å¤„ç†å¼‚æ­¥,è€Œ **tapAsync** åˆ™éœ€è¦ç”¨ callback æ¥è¿”å›ç»“æœ
3. é™¤äº†åŒæ­¥å’Œå¼‚æ­¥çš„,åç§°å¸¦æœ‰ **parallel** çš„,æ³¨å†Œçš„äº‹ä»¶å‡½æ•°ä¼šå¹¶è¡Œè°ƒç”¨,åç§°å¸¦æœ‰ **bail** çš„,æ³¨å†Œçš„äº‹ä»¶å‡½æ•°ä¼šè¢«é¡ºåºè°ƒç”¨,ç›´è‡³ä¸€ä¸ªå¤„ç†æ–¹æ³•æœ‰è¿”å›å€¼åç§°å¸¦æœ‰ **waterfall**çš„,æ¯ä¸ªæ³¨å†Œçš„äº‹ä»¶å‡½æ•°,ä¼šå°†ä¸Šä¸€ä¸ªæ–¹æ³•çš„è¿”å›ç»“æœä½œä¸ºè¾“å…¥å‚æ•°.

<font color='red'> å¼‚æ­¥äº‹ä»¶é’©å­</font>

**tapPromise**

```js
class HelloAsyncPlugin {
  apply(compiler) {
    compiler.hooks.emit.tapPromise('HelloAsyncPlugin', compilation => {
      // è¿”å›ä¸€ä¸ª Promiseï¼Œåœ¨æˆ‘ä»¬çš„å¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶ resolveâ€¦â€¦
      return new Promise((resolve, reject) => {
        setTimeout(function() {
          console.log('å¼‚æ­¥å·¥ä½œå®Œæˆâ€¦â€¦');
          resolve();
        }, 1000);
      });
    });
  }
}

module.exports = HelloAsyncPlugin;
```

**tapAsync**
```js
class HelloAsyncPlugin {
  apply(compiler) {
    compiler.hooks.emit.tapAsync('HelloAsyncPlugin', (compilation, callback) => {
      // åšä¸€äº›å¼‚æ­¥çš„äº‹æƒ…â€¦â€¦
      setTimeout(function() {
        console.log('Done with async work...');
        callback();
      }, 1000);
    });
  }
}

module.exports = HelloAsyncPlugin;
```

## ç¼–å†™è‡ªå·±çš„Loader
loader æœ¬å­å°±æ˜¯æ¥æ”¶å­—ç¬¦ä¸²(æˆ–è€…buffer),å†è¿”å›å¤„ç†å®Œçš„å­—ç¬¦ä¸²(æˆ–è€…buffer)çš„è¿‡ç¨‹. webpack ä¼šå°†åŠ è½½çš„èµ„æºä½œä¸ºå‚æ•°ä¼ å…¥ loaderæ–¹æ³•,äº¤ä¸ loader å¤„ç†,å†è¿”å› å¦‚ä¸‹ ç¼–å†™ä¸€ä¸ªç®€å•çš„ loader:
```js
const loaderUtils = require('loader-utils')
const path = require('path')
// å°±æ˜¯æ–‡ä»¶å†…å®¹
module.exports = function (source) {
    // è·å–loaderé…ç½®
    onst loaderOptions = loaderUtils.getOptions(this);
    return source.replace('xikun', 'myloader')   
}
```

åœ¨è½¬æ¢æ­¥éª¤æ˜¯å¼‚æ­¥æ—¶,å¯ä»¥è¿™æ ·

```js
module.exports = function(source) {
    // å‘Šè¯‰ Webpack æœ¬æ¬¡è½¬æ¢æ˜¯å¼‚æ­¥çš„ï¼ŒLoader ä¼šåœ¨ callback ä¸­å›è°ƒç»“æœ
    var callback = this.async();
    setTimeout(source, function(err, result, sourceMaps, ast) {
        // é€šè¿‡ callback è¿”å›å¼‚æ­¥æ‰§è¡Œåçš„ç»“æœ
        callback(err, result, sourceMaps, ast);
    },1000);
};
```

**å¤„ç†äºŒè¿›åˆ¶æ•°æ®**
Webpackä¼ ç»™Loaderçš„åŸå†…å®¹éƒ½æ˜¯UTF-8æ ¼å¼ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ ä½†æœ‰äº›åœºæ™¯ä¸‹Loaderä¸æ˜¯å¤„ç†æ–‡æœ¬æ–‡ä»¶ï¼Œè€Œæ˜¯å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¾‹å¦‚file-loaderï¼Œå°±éœ€è¦Webpackç»™Loaderä¼ å…¥äºŒè¿›åˆ¶æ ¼å¼çš„æ•°æ®ã€‚

```js
module.exports = function(source) {
    // åœ¨ exports.raw === true æ—¶ï¼ŒWebpack ä¼ ç»™ Loader çš„ source æ˜¯ Buffer ç±»å‹çš„
    source instanceof Buffer === true;
    // Loader è¿”å›çš„ç±»å‹ä¹Ÿå¯ä»¥æ˜¯ Buffer ç±»å‹çš„
    // åœ¨ exports.raw !== true æ—¶ï¼ŒLoader ä¹Ÿå¯ä»¥è¿”å› Buffer ç±»å‹çš„ç»“æœ
    return source;
};
// é€šè¿‡ exports.raw å±æ€§å‘Šè¯‰ Webpack è¯¥ Loader æ˜¯å¦éœ€è¦äºŒè¿›åˆ¶æ•°æ® 
module.exports.raw = true;
```