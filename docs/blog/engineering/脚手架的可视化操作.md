# è„šæ‰‹æ¶çš„å¯è§†åŒ–æ“ä½œ

ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬ä»‹ç»äº†é€šè¿‡ç»ˆç«¯å‘½åçš„æ–¹å¼ å»æ‹‰å–ä¸€ä¸ªé¡¹ç›®,ä¸€ä¸ªä¸ªçš„é…ç½®éƒ½æ˜¯æˆ‘ä»¬é€šè¿‡ç»ˆç«¯å‘½ä»¤ æ¥è¿›è¡Œæ“ä½œçš„,ç°åœ¨æˆ‘ä»¬è¦åšå°±æ˜¯é€šè¿‡ç»ˆç«¯æ¥æ‰“å¼€æµè§ˆå™¨ç•Œé¢,ç„¶åç”¨æˆ·å¡«å…¥ æ–‡ä»¶å å’Œå¯¹åº”çš„æ¥å£åœ°å€,å¯ä»¥å¸®æˆ‘ä»¬æ ¹æ®è¿”å›ç»“æœè‡ªåŠ¨ç”Ÿæˆ **TS** ç±»


## ç”¨ Node æ‰“å¼€æµè§ˆå™¨çª—å£ 

æœ‰äº†ä¸Šé¢çš„æ„æƒ³,æˆ‘ä»¬é¦–å…ˆ è¦åšçš„:
- é€šè¿‡ç»ˆç«¯æ¥å—æ‰“å¼€æµè§ˆå™¨çª—å£çš„å‘½å
- ç”¨Node æ‰“å¼€æµè§ˆå™¨çª—å£
- åœ¨å¯è§†åŒ–é¡µé¢ä¸Šè¿›è¡Œæ“ä½œ
- è°ƒç”¨Nodeè¿›è¡Œä¸€ç³»åˆ—æ“ä½œ
- æµè§ˆå™¨çª—å£å…³é—­,Nodeé€€å‡º

æ¥å—å‘½åæˆ‘ä»¬ä¸Šç« èŠ‚å·²ç»å®šä¹‰å¥½äº†

```js
 program.option('json2ts', 'è¾“å…¥æ¥å£åœ°å€,è‡ªåŠ¨ç”ŸæˆTypeScriptç±» ğŸ¥±')
 json2ts() {
        createServer()
    },
```

æ‰“å¼€æµè§ˆå™¨çª—å£ä¹Ÿå¾ˆç®€å•,æˆ‘ä»¬åªè¦ä½¿ç”¨ Node çš„ **child_process** æ¨¡å—å³å¯

```js
const { exec } = require('child_process')
const localhost = 'http:127.0.0.1:8088/'

switch (process.platform) {
    macç³»ç»Ÿä½¿ç”¨ ä¸€ä¸‹å‘½ä»¤æ‰“å¼€urlåœ¨æµè§ˆå™¨
    case "darwin":
        exec(`open ${localhost}`);
    winç³»ç»Ÿä½¿ç”¨ ä¸€ä¸‹å‘½ä»¤æ‰“å¼€urlåœ¨æµè§ˆå™¨
    case "win32":
        exec(`start ${localhost}`);
     é»˜è®¤macç³»ç»Ÿ
    default:
        exec(`open ${localhost}`);
}
```

OK,ç°åœ¨æˆ‘ä»¬æˆåŠŸçš„æ‰“å¼€äº†æµè§ˆå™¨ç•Œé¢,ä½†æ˜¯ä½ ä¼šè¯´æ˜¯ç©ºçš„å•Š,åˆ«æ€¥,æˆ‘ä»¬æ…¢æ…¢å¾€ä¸‹æ•´.

è¯´åˆ°å¯ä½¿ç”¨é¡µé¢,é‚£è‚¯å®šæˆ‘ä»¬å°‘ä¸äº† **HTML** é¡µé¢,OK, æˆ‘ä»¬åœ¨ æ–°å»º views/index.html,éšä¾¿å†™ç‚¹å†…å®¹

**main.js**

```js
 http.createServer(function (req, res) {
     if (req.url === "/") {
         const pathname = `${path.join(process.cwd(), '../')}views/index.html`
         fs.exists(pathname, function (exists) {
             if (exists) {
                 res.writeHead(200, { "Content-Type": "text/html" });
             }
             fs.readFile(pathname, function (err, data) {
                 console.log(data);
                 if (err) {
                     console.log("æœåŠ¡å¼‚å¸¸");
                     process.exit(-1)
                 }
                 res.end(data)
             })
         })
     } 
     else {
         res.end("404")
     }

 }).listen(8088, "127.0.0.1")

// è‡ªåŠ¨æ‰“å¼€é»˜è®¤æµè§ˆå™¨
...
```

ç°åœ¨æ‰§è¡Œå‘ç° æˆ‘ä»¬çš„æµè§ˆå™¨èƒ½é¡ºåˆ©æ‰“å¼€,æˆ‘ä»¬çš„ **HTML** ä¹Ÿèƒ½æ‰“å¼€äº†.

## æ¥å…¥ Koa 
åˆ«é—®,é—®å°±æ˜¯ **koa**,ç”¨åŸç”Ÿæ“ä½œæ˜¯åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œä¸å¤šè¯´

```
npm install koa koa-router koa-static koa-swig child_process
```

>**koa-swig** æ˜¯ä¸€ä¸ªæ¨¡æ¿å¼•æ“,å…·æœ‰å¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½,

é…ç½® ä¸€ä¸‹

```js
app.context.render = wrap(
    render({
        root: viewDir,
        autoescape: true,
        cache: false,
        ext: 'html',
        varControls: ['[[', ']]'],
        writeBody: false,
    })
);
```

OK,æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯ ç”¨æˆ·åœ¨é¡µé¢,å¡«å®Œ æ–‡ä»¶å,æ¥å£åœ°å€ ç‚¹å‡»ç¡®å®š,æŠŠè¯·æ±‚å‘é€åˆ°æœ¬åœ° **Koa**

```js
router.post('/download', async (ctx) => {
    const { list = [] } = ctx.request.body

    const spinner = ora(`â° ${chalk.gray(`æ­£åœ¨ç”Ÿæˆæ¥å£æ–‡æ¡£ä¸­ âŒ›ï¸`)}`).start();
    const promises = []
    list.forEach(({ dirName, url }) => {
        const promise = new Promise((resolve) => {
            axios.get(url)
                .then(res => resolve({ data: res.data, dirName: dirName }))
                .catch(resolve);
        });
        promises.push(promise);
    });

    try {
        const datas = await Promise.all(promises)
        for (const data of datas) {
            await generateTsJson(data.data, data.dirName, spinner)
        }
        ctx.body = {
            status: 200
        }
        setTimeout(() => {
            process.exit()
        }, 1500);
    } catch (error) {
        console.log(error);
        spinner.fail(chalk.red('ç”Ÿæˆæ¥å£æ–‡æ¡£å¤±è´¥ ğŸ˜­'))
        process.exit(-1)
    }
})
```

å®‰è£… json2ts

>json2tså¯æŠŠ JSON å¯¹è±¡è½¬æˆ ts æ¥å£ ç±»

```
npm install json2ts
```

**generateTsJson**

```js
function generateTsJson(jsonContent, dirName, spinner) {

    const result = json2ts.convert(JSON.stringify(jsonContent, null, 4))
    try {
        //  åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½•
        if (fs.existsSync(dir)) {
            xshell.cd(dir)
            writeFile(dirName, result, spinner)
        } else {
            fs.mkdirSync('docs')
            xshell.cd(dir)
            writeFile(dirName, result, spinner)
        }
    } catch (error) {
        console.log(error);
        spinner.fail(chalk.red('ç”Ÿæˆæ¥å£æ–‡æ¡£å¤±è´¥ ğŸ˜­'))
        process.exit(-1)
    }
}

function writeFile(dirName, result, spinner) {
    fs.writeFile(`${dirName}.ts`, result, 'utf-8', function (err) {
        if (err) {
            spinner.fail(chalk.red('ç”Ÿæˆæ¥å£æ–‡æ¡£å¤±è´¥ ğŸ˜­'))
            process.exit(-1)
        }
        spinner.succeed(`${chalk.green(`ç”Ÿæˆæ–‡æ¡£${dirName}.ts æˆåŠŸ ğŸ˜„`)}`)
    })
}
```

é¦–å…ˆæˆ‘ä»¬æ¥å—ä¸€ä¸ª æ•°ç»„, é‡Œé¢çš„å¯¹è±¡æœ‰ **dirName**:ä¿å­˜çš„æ–‡ä»¶å,**url** è¦è¯·æ±‚çš„æ¥å£åœ°å€

ç„¶åä¾æ¬¡å‘é€è¯·æ±‚,æ‹¿åˆ°ç»“æœå ä½¿ç”¨ **json2ts** æ¥ç”Ÿæˆ **.ts** æ–‡ä»¶ åˆ° **docs/** ç›®å½•ä¸‹